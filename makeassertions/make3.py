import os
import re
import json
import anthropic

# --- è¨­å®šé …ç›® ---

# 1. Claude APIã‚­ãƒ¼ã®è¨­å®š
# ç’°å¢ƒå¤‰æ•° `ANTHROPIC_API_KEY` ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
try:
    if not os.environ.get("ANTHROPIC_API_KEY"):
        raise KeyError
except KeyError:
    print("ã‚¨ãƒ©ãƒ¼: ç’°å¢ƒå¤‰æ•° `ANTHROPIC_API_KEY` ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
    exit(1)

# 2. ç”ŸæˆAIã«ä¸ãˆã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
# AIã«å‡ºåŠ›ã—ã¦ã»ã—ã„æƒ…å ±ã®å½¢å¼ã‚’ã€JSONã‚¹ã‚­ãƒ¼ãƒã§å³å¯†ã«æŒ‡å®šã—ã¾ã™ã€‚
# JSONã®ä¾‹ã§ä½¿ã†æ³¢æ‹¬å¼§ã‚’{{ }}ã®ã‚ˆã†ã«äºŒé‡ã«ã—ã¦ã€formatãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã—ã¾ã™ã€‚
PROMPT_TEMPLATE = """
ã‚ãªãŸã¯ã€Pythonã‚³ãƒ¼ãƒ‰ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç”Ÿæˆã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚
æ—¢å­˜ã®Pythonã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒãƒƒã‚°ãƒ—ãƒªãƒ³ãƒˆã‚’æŒ¿å…¥ã™ã‚‹éš›ã«å‚è€ƒã«ãªã‚‹ã‚ˆã†ãªä¾‹ã‚’ä½œæˆã™ã‚‹ã®ãŒä»•äº‹ã§ã™ã€‚

ä»¥ä¸‹ã®æŒ‡ç¤ºã«å¾“ã£ã¦ã€æŒ‡å®šã•ã‚ŒãŸå½¢å¼ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’5å€‹ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

### æŒ‡ç¤º
- **æœ€é‡è¦ãƒ«ãƒ¼ãƒ«: ç”Ÿæˆã™ã‚‹JSONã¯ã€å…¨ä½“ã¨ã—ã¦å®Œå…¨ã«æœ‰åŠ¹ãªå½¢å¼ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ç‰¹ã«ã€æ–‡å­—åˆ—å€¤ã®ä¸­ã®ç‰¹æ®Šæ–‡å­—ï¼ˆæ”¹è¡Œã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆï¼‰ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã«ã¯ç´°å¿ƒã®æ³¨æ„ã‚’æ‰•ã£ã¦ãã ã•ã„ã€‚**
- å¤šæ§˜ãªPythoné–¢æ•°ã‚’é¡Œæã¨ã—ã¦ãã ã•ã„ã€‚
- å„é–¢æ•°ã«ã€é©åˆ‡ãªã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒãƒƒã‚°ãƒ—ãƒªãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
- ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€é–¢æ•°ã®äº‹å‰æ¡ä»¶ï¼ˆå¼•æ•°ã®å‹ã€å€¤ã®ç¯„å›²ãªã©ï¼‰ã‚’å³å¯†ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚
- ãƒ‡ãƒãƒƒã‚°ãƒ—ãƒªãƒ³ãƒˆã¯ã€å‡¦ç†ã®é–‹å§‹ã€ä¸»è¦ãªå¤‰æ•°ã®çŠ¶æ…‹ã€å‡¦ç†ã®çµ‚äº†ãªã©ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å‹•ä½œãŒè¿½è·¡ã—ã‚„ã™ããªã‚‹ã‚ˆã†ã«f-stringã‚’ä½¿ã£ã¦æŒ¿å…¥ã—ã¦ãã ã•ã„ã€‚
- **`success`ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¯ã€æ­£å¸¸ç³»ã®å‹•ä½œãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã™ã¹ã¦ç¶²ç¾…ã™ã‚‹ã‚ˆã†ã«ã€æœ€ä½1ã¤ä»¥ä¸Šã€å¿…è¦ãªæ•°ã ã‘ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚**
- **`failure`ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¯ã€æƒ³å®šã•ã‚Œã‚‹å„ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã«ãã‚Œãã‚Œå¼•ã£ã‹ã‹ã‚‹ã‚ˆã†ã«ã€æŒ¿å…¥ã—ãŸã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã®æ•°ã«åˆã‚ã›ã¦ã€å¿…è¦ãªæ•°ã ã‘ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚** ã“ã‚Œã«ã‚ˆã‚Šã€å…¨ã¦ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ†ã‚¹ãƒˆå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

{additional_instructions}

### æ³¨æ„
- ç”Ÿæˆã™ã‚‹å„JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€**å¿…ãš**ä»¥ä¸‹ã®ã‚¹ã‚­ãƒ¼ãƒã«å¾“ã£ã¦ãã ã•ã„ã€‚
- `input`ã‚„`expected_output`ã®å€¤ã¯ã€Pythonã®æ§‹æ–‡ã¨ã—ã¦æ­£ã—ã„æ–‡å­—åˆ—ã«ã—ã¦ãã ã•ã„ (ä¾‹: æ–‡å­—åˆ—ãªã‚‰`"'hello'"`ã€ãƒªã‚¹ãƒˆãªã‚‰`"[1, 2]"`ãªã©)ã€‚
- `description`ã«è¨˜è¼‰ã™ã‚‹èª¬æ˜ã¯é–¢æ•°ãã‚Œè‡ªä½“ã®èª¬æ˜ã§ã¯ãªãã€ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒãƒƒã‚°ãƒ—ãƒªãƒ³ãƒˆã®æŒ¿å…¥æ„å›³ã¨ã€ãã®æŒ¿å…¥ãŒæœ‰åŠ¹ã¨åˆ¤æ–­ã§ãã‚‹æ¡ä»¶ã®èª¬æ˜ã‚’ä¸­å¿ƒã¨ã—ã¦ãã ã•ã„ã€‚
- å¯¾è±¡ã¨ã™ã‚‹é–¢æ•°ã‚’å±€æ‰€çš„ã™ãã‚‹ã‚‚ã®ã€è¤‡é›‘ã™ãã‚‹ã‚‚ã®ã«ã›ãšã€ä¾‹ã¨ã—ã¦ã‚ã‚‹ç¨‹åº¦ã®æ±ç”¨æ€§ã‚’ç¶­æŒã—ã¦ãã ã•ã„ã€‚
- é–¢æ•°ã®æ„å›³ã‚’è€ƒãˆãšã¨ã‚‚ã€å˜ã«æ§‹æ–‡ã®å½¢ã®ã¿ã‚’è¦‹ã¦æŒ¿å…¥ã§ãã‚‹ã‚‚ã®ãªã©ã€å˜ç´”ãªä¾‹ã‚’å«ã‚ã¦æ§‹ã„ã¾ã›ã‚“ã€‚ãã®å ´åˆã€ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã—ã‹æŒ¿å…¥ã—ãªã„ã‚±ãƒ¼ã‚¹ã€ã‚ã‚‹ã„ã¯ãƒ‡ãƒãƒƒã‚°ãƒ—ãƒªãƒ³ãƒˆã—ã‹æŒ¿å…¥ã—ãªã„ã‚±ãƒ¼ã‚¹ãŒã‚ã£ã¦æ§‹ã„ã¾ã›ã‚“ã€‚
- ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³åŠã³ãƒ‡ãƒãƒƒã‚°ãƒ—ãƒªãƒ³ãƒˆã®æŒ¿å…¥ã¯ã§ãã‚‹é™ã‚Šå¤šãè¡Œã£ã¦ãã ã•ã„ã€‚å¤‰æ•°ã®ä¸­èº«ã®ç¢ºèªãªã©ã¯ç‰¹ã«æ¼ã‚‰ã•ãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

### å‡ºåŠ›JSONã‚¹ã‚­ãƒ¼ãƒ
```json
{{
  "title": "ã“ã®é–¢æ•°ã®å½¹å‰²ã‚’ç¤ºã™ç°¡å˜ãªã‚¿ã‚¤ãƒˆãƒ«ã§ã™ (ä¾‹: 'è¾æ›¸ã‹ã‚‰å€¤ã‚’å®‰å…¨ã«å–å¾—ã™ã‚‹é–¢æ•°')ã€‚",
  "description": "ã“ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒãƒƒã‚°ãƒ—ãƒªãƒ³ãƒˆã®ã‚»ãƒƒãƒˆãŒæœ‰åŠ¹ãªçŠ¶æ³ã«ã¤ã„ã¦ã®çŸ­ã„èª¬æ˜ã§ã™ã€‚ã©ã®ã‚ˆã†ãªæ§‹æ–‡ã‚„æ¡ä»¶ã®éš›ã«ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨ã™ã¹ãã‹è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚",
  "keywords": [
    "ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œè¨ã™ã‚‹ãã£ã‹ã‘ã¨ãªã‚‹Pythonã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„é–¢æ•°åã®ãƒªã‚¹ãƒˆã§ã™ã€‚ï¼ˆä¾‹: 'if', 'for', 'dict.get'ï¼‰"
  ],
  "code_before": "ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å‰ã®Pythonã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã§ã™ã€‚",
  "code_after": "ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒãƒƒã‚°ãƒ—ãƒªãƒ³ãƒˆã‚’è¿½åŠ ã—ãŸå¾Œã®Pythonã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã§ã™ã€‚JSONã®æ–‡å­—åˆ—å€¤ã¨ã—ã¦æœ‰åŠ¹ã«ãªã‚‹ã‚ˆã†ã€ã‚³ãƒ¼ãƒ‰å†…ã®æ”¹è¡Œã¯'\\\\n'ã«ã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã¯'\\\"'ã«å¿…ãšã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ãã ã•ã„ã€‚ (ä¾‹: 'def my_func():\\\\n    print(\\\"hello\\\")')",
  "test_cases": {{
    "success": [
      {{
        "input": ["ï¼ˆæ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆã®å¼•æ•°1ï¼‰", "ï¼ˆå¼•æ•°2ï¼‰"],
        "expected_output": "ï¼ˆæ­£å¸¸ã«å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã®è¿”ã‚Šå€¤ï¼‰"
      }}
    ],
    "failure": [
      {{
        "input": ["ï¼ˆã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³1ã«å¼•ã£ã‹ã‹ã‚‹å¼•æ•°ï¼‰"],
        "expected_exception": "AssertionError",
        "expected_message_part": "ï¼ˆã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³1ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸€éƒ¨ï¼‰"
      }}
    ]
  }}
}}
```

### ç”Ÿæˆé–‹å§‹
å„JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é–“ã¯ã€å¿…ãš `---` ã§åŒºåˆ‡ã£ã¦ãã ã•ã„ã€‚
```
---
```
"""

# 3. å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å
OUTPUT_FILENAME = "rich_assertion_dataset.jsonl"

# --- é–¢æ•°å®šç¾© ---

def read_existing_titles(filename: str) -> list[str]:
    """
    æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€ã€‚
    """
    titles = []
    if not os.path.exists(filename):
        return titles

    try:
        with open(filename, 'r', encoding='utf-8') as f:
            for line in f:
                try:
                    data = json.loads(line)
                    if 'title' in data and data['title']:
                        titles.append(data['title'])
                except json.JSONDecodeError:
                    # ä¸æ­£ãªè¡Œã¯ç„¡è¦–
                    continue
        print(f"ğŸ“– æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰{len(titles)}ä»¶ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚")
    except Exception as e:
        print(f"âš ï¸ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
    
    return titles

def generate_text_from_ai(prompt: str) -> str | None:
    """æŒ‡å®šã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ã£ã¦ã€Claude APIã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€‚"""
    print("ğŸ¤– Claudeã«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚’å•ã„åˆã‚ã›ä¸­...")
    try:
        client = anthropic.Anthropic()
        message = client.messages.create(
            model="claude-3-7-sonnet-latest",
            max_tokens=4096,
            system="ã‚ãªãŸã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã«å³å¯†ã«å¾“ã£ã¦ã€å®Œç’§ã«æœ‰åŠ¹ãªJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿ã‚’ç”Ÿæˆã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ç‰¹ã«ã€JSONæ–‡å­—åˆ—å†…ã®æ”¹è¡Œã¯`\\n`ã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã¯`\\\"`ã¨ã—ã¦ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ãƒ«ãƒ¼ãƒ«ã‚’çµ¶å¯¾ã«éµå®ˆã—ã¦ãã ã•ã„ã€‚",
            messages=[
                {"role": "user", "content": prompt}
            ]
        )
        print("âœ… Claudeã‹ã‚‰ã®å¿œç­”ã‚’å–å¾—ã—ã¾ã—ãŸã€‚")
        return message.content[0].text.strip().removeprefix("---").strip()
    except Exception as e:
        print(f"âŒ APIå‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return None

def parse_refactoring_json(generated_text: str) -> list[dict]:
    """AIãŒç”Ÿæˆã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æƒ…å ±ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŠ½å‡ºã™ã‚‹ã€‚"""
    print("ğŸ” å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æä¸­...")
    dataset = []
    # æˆ¦ç•¥1: ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã®JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¢ã™ (æœ€å„ªå…ˆ)
    json_blocks_in_markdown = re.findall(r'```json\s*({[\s\S]*?})\s*```', generated_text, re.DOTALL)
    
    if json_blocks_in_markdown:
        print(f"ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã®JSONå€™è£œã‚’{len(json_blocks_in_markdown)}ä»¶è¦‹ã¤ã‘ã¾ã—ãŸã€‚")
        for i, json_string in enumerate(json_blocks_in_markdown):
            try:
                data_item = json.loads(json_string.strip())
                dataset.append(data_item)
            except json.JSONDecodeError as e:
                print(f"ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ–ãƒ­ãƒƒã‚¯ {i+1} ã®JSONè§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
                print(f"å•é¡Œã®ãƒ–ãƒ­ãƒƒã‚¯:\n{json_string.strip()}")
        
        print(f"ğŸ‘ {len(dataset)}å€‹ã®ãƒ‡ãƒ¼ã‚¿é …ç›®ã‚’æŠ½å‡ºã—ã¾ã—ãŸã€‚")
        return dataset

    # æˆ¦ç•¥2: ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€RAWãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ç›´æ¥JSONã‚’æ¢ã™ (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
    print("ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã®JSONãƒ–ãƒ­ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚RAWãƒ†ã‚­ã‚¹ãƒˆã®è§£æã‚’è©¦ã¿ã¾ã™ã€‚")
    major_blocks = generated_text.strip().split('---')
    
    for i, block in enumerate(major_blocks):
        if not block.strip():
            continue
        
        # ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã‹ã‚‰JSONã®éƒ¨åˆ†ã ã‘ã‚’æ¢ã—å‡ºã™
        match = re.search(r'({[\s\S]*})', block, re.DOTALL)
        if match:
            json_string = match.group(1)
            try:
                data_item = json.loads(json_string.strip())
                dataset.append(data_item)
            except json.JSONDecodeError as e:
                print(f"RAWãƒ–ãƒ­ãƒƒã‚¯ {i+1} ã®JSONè§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
                print(f"å•é¡Œã®ãƒ–ãƒ­ãƒƒã‚¯:\n{json_string.strip()}")
        else:
            print(f"RAWãƒ–ãƒ­ãƒƒã‚¯ {i+1} ã§æœ‰åŠ¹ãªJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
            
    if not dataset:
         print("å¿œç­”å†…ã«æœ‰åŠ¹ãªJSONãƒ–ãƒ­ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
         return []

    print(f"ğŸ‘ {len(dataset)}å€‹ã®ãƒ‡ãƒ¼ã‚¿é …ç›®ã‚’æŠ½å‡ºã—ã¾ã—ãŸã€‚")
    return dataset

def save_to_jsonl(data: list[dict], filename: str):
    """æŠ½å‡ºã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’JSON Lineså½¢å¼ã§ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜ä¿å­˜ã™ã‚‹ã€‚"""
    print(f"ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ `{filename}` ã«è¿½è¨˜ä¿å­˜ä¸­...")
    try:
        with open(filename, 'a', encoding='utf-8') as f:
            for item in data:
                f.write(json.dumps(item, ensure_ascii=False) + '\n')
        print("ğŸ‰ è¿½è¨˜ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
    except IOError as e:
        print(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãè¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

# --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
if __name__ == "__main__":
    # 1. æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
    existing_titles = read_existing_titles(OUTPUT_FILENAME)
    
    # 2. æ—¢å­˜ã‚¿ã‚¤ãƒˆãƒ«ãƒªã‚¹ãƒˆã«åŸºã¥ã„ã¦è¿½åŠ ã®æŒ‡ç¤ºã‚’ä½œæˆ
    additional_instructions = ""
    if existing_titles:
        # set()ã§é‡è¤‡ã‚’é™¤å¤–ã—ã¦ã‹ã‚‰ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
        titles_str = "\n".join(f"- {title}" for title in set(existing_titles))
        additional_instructions = f"""
# æ—¢å­˜ã®ãƒ†ãƒ¼ãƒãƒªã‚¹ãƒˆ
ã“ã‚Œã‚‰ã¯ã™ã§ã«ãƒ‡ãƒ¼ã‚¿ãŒä½œã‚‰ã‚ŒãŸé–¢æ•°ã®ãƒ†ãƒ¼ãƒã§ã™ã€‚ã§ãã‚‹é™ã‚Šã“ã‚Œã‚‰ã¨è¢«ã‚‰ãªã„é–¢æ•°ã«ã¤ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
{titles_str}
"""
    
    # 3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    final_prompt = PROMPT_TEMPLATE.format(additional_instructions=additional_instructions)
    
    # 4. AIã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
    generated_text = generate_text_from_ai(final_prompt)

    if generated_text:
        # 5. ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚³ãƒ¼ãƒ‰ãƒšã‚¢ã‚’æŠ½å‡º
        dataset = parse_refactoring_json(generated_text)
        
        if dataset:
            # 6. æŠ½å‡ºã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜ä¿å­˜
            save_to_jsonl(dataset, OUTPUT_FILENAME)
        else:
            print("æŠ½å‡ºã§ãã‚‹æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
